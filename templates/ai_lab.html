{% extends 'base.html' %}

{% block title %}{{ _('ai_lab.title') }}{% endblock %}

{% block extra_style %}
.ai-preset-card {
    background: var(--gradient-card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius-lg);
    transition: all var(--transition-fast);
    cursor: pointer;
    padding: 1.5rem;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
}

.ai-preset-card:hover {
    transform: translateY(-2px);
    border-color: var(--spotify-green);
    box-shadow: 0 8px 25px rgba(29, 185, 84, 0.2);
}

.ai-preset-card.selected {
    border-color: var(--spotify-green);
    background: rgba(29, 185, 84, 0.1);
}

.preset-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: #000;
}

.suggestion-pill {
    background: var(--bg-tertiary);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius-lg);
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: inline-block;
    font-size: 0.85rem;
}

.suggestion-pill:hover {
    background: var(--bg-hover);
    border-color: var(--spotify-green);
    transform: translateY(-1px);
}

.suggestion-pill.active {
    background: var(--spotify-green);
    color: #000;
    border-color: var(--spotify-green);
}

.chat-container {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    border: 1px solid rgba(255,255,255,0.1);
}

.chat-message {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: var(--radius-md);
    max-width: 80%;
    position: relative;
}

.chat-message.user {
    background: var(--spotify-green);
    color: #000;
    margin-left: auto;
    text-align: right;
}

.chat-message.assistant {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    margin-right: auto;
}

.chat-message .timestamp {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 0.5rem;
}

.prompt-input-container {
    position: relative;
}

.prompt-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius-md);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background var(--transition-fast);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.suggestion-item:hover {
    background: var(--bg-hover);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.playlist-timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 0.5rem;
    width: 12px;
    height: 12px;
    background: var(--spotify-green);
    border-radius: 50%;
}

.timeline-item:after {
    content: '';
    position: absolute;
    left: -1.06rem;
    top: 1.5rem;
    width: 2px;
    height: calc(100% - 1rem);
    background: rgba(29, 185, 84, 0.3);
}

.timeline-item:last-child:after {
    display: none;
}

/* Compact Preset Tabs */
.preset-tabs {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 1rem;
}

.preset-tab {
    display: inline-block;
    padding: 0.5rem 1rem;
    margin-right: 0.5rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all var(--transition-fast);
    font-size: 0.85rem;
    font-weight: 500;
}

.preset-tab.active {
    color: var(--spotify-green);
    border-bottom-color: var(--spotify-green);
}

.preset-tab:hover {
    color: var(--spotify-green);
    background: rgba(29, 185, 84, 0.1);
}

.preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
}

.preset-card-compact {
    background: var(--bg-tertiary);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.preset-card-compact:hover {
    border-color: var(--spotify-green);
    background: rgba(29, 185, 84, 0.1);
    transform: translateY(-2px);
}

.preset-card-compact.selected {
    border-color: var(--spotify-green);
    background: rgba(29, 185, 84, 0.2);
}

.preset-card-compact .preset-icon {
    margin-bottom: 0.5rem;
}

.preset-card-compact h6 {
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
}

.preset-card-compact p {
    font-size: 0.7rem;
    margin-bottom: 0;
    opacity: 0.8;
}

{% endblock %}

{% block content %}
<!-- Compact Header -->
<div class="d-flex align-items-center justify-content-between mb-3 animate-slide-up">
    <div class="d-flex align-items-center">
        <div class="me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
            <i data-lucide="brain" style="width: 24px; height: 24px; color: #000;"></i>
        </div>
        <div>
            <h1 class="mb-1" style="font-size: 1.8rem; font-weight: 700;">{{ _('ai_lab.title') }}</h1>
            <p class="text-secondary mb-0 small">{{ _('ai_lab.subtitle') }}</p>
        </div>
    </div>
    
    <!-- User Selection in Header -->
    <form class="d-flex align-items-center gap-2" id="user-filter-form" method="get" action="{{ url_for('ai_lab') }}">
        <i data-lucide="user" style="width: 16px; height: 16px; color: var(--spotify-green);"></i>
        <select name="user" id="user-select" class="form-select form-select-sm" style="max-width: 150px;" onchange="this.form.submit()">
            <option value="main" {% if selected_user == 'main' %}selected{% endif %}>{{ aliases.main }}</option>
            <option value="secondary" {% if selected_user == 'secondary' %}selected{% endif %}>{{ aliases.secondary }}</option>
        </select>
    </form>
</div>

<div class="row">
    <!-- AI Presets Section - Compact Tabbed Version -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100 animate-slide-up" style="animation-delay: 0.2s;">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i data-lucide="sparkles" class="me-3" style="width: 24px; height: 24px; color: var(--accent-yellow);"></i>
                    <h3 class="card-title mb-0">{{ _('ai_lab.preset_title') }}</h3>
                </div>
                <p class="text-secondary small mb-3">{{ _('ai_lab.quick_presets_desc') }}</p>
                
                <!-- Compact Preset Tabs -->
                <div class="preset-tabs">
                    <button class="preset-tab active" data-category="mood">
                        üéµ {% if current_language == 'en' %}Mood{% else %}Mood{% endif %}
                    </button>
                    <button class="preset-tab" data-category="genre">
                        üé∏ {% if current_language == 'en' %}Genre{% else %}Generi{% endif %}
                    </button>
                    <button class="preset-tab" data-category="era">
                        üìÖ {% if current_language == 'en' %}Era{% else %}Epoca{% endif %}
                    </button>
                </div>
                
                <!-- Mood Presets Grid -->
                <div class="preset-grid" id="mood-presets">
                    <div class="preset-card-compact" data-preset="energia" data-category="mood">
                        <i data-lucide="zap" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.presets.workout.title') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.presets.workout.description') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="relax" data-category="mood">
                        <i data-lucide="moon" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.presets.chill.title') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.presets.chill.description') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="focus" data-category="mood">
                        <i data-lucide="brain" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.presets.focus.title') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.presets.focus.description') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="party" data-category="mood">
                        <i data-lucide="party-popper" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.presets.party.title') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.presets.party.description') }}</p>
                    </div>
                </div>
                
                <!-- Genre Presets Grid -->
                <div class="preset-grid" id="genre-presets" style="display: none;">
                    <div class="preset-card-compact" data-preset="rock-classics" data-category="genre">
                        <i data-lucide="guitar" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.genres.rock_classic') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.genres.rock_classic_desc') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="italian-music" data-category="genre">
                        <i data-lucide="heart" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.genres.italian_music') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.genres.italian_music_desc') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="electronic" data-category="genre">
                        <i data-lucide="radio" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.genres.electronic_edm') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.genres.electronic_edm_desc') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="jazz" data-category="genre">
                        <i data-lucide="music" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{% if current_language == 'en' %}Jazz{% else %}Jazz{% endif %}</h6>
                        <p class="text-secondary">{% if current_language == 'en' %}Smooth jazz and classics{% else %}Jazz raffinato e classici{% endif %}</p>
                    </div>
                </div>
                
                <!-- Era Presets Grid -->
                <div class="preset-grid" id="era-presets" style="display: none;">
                    <div class="preset-card-compact" data-preset="80s-90s" data-category="era">
                        <i data-lucide="disc" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.eras.80s_90s') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.eras.80s_90s_desc') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="2000s" data-category="era">
                        <i data-lucide="play-circle" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{{ _('ai_lab.eras.2000s') }}</h6>
                        <p class="text-secondary">{{ _('ai_lab.eras.2000s_desc') }}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="2010s" data-category="era">
                        <i data-lucide="smartphone" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{% if current_language == 'en' %}2010s{% else %}Anni 2010{% endif %}</h6>
                        <p class="text-secondary">{% if current_language == 'en' %}Streaming era hits{% else %}Hit era streaming{% endif %}</p>
                    </div>
                    
                    <div class="preset-card-compact" data-preset="2020s" data-category="era">
                        <i data-lucide="headphones" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <h6 class="fw-bold mb-1">{% if current_language == 'en' %}2020s{% else %}Anni 2020{% endif %}</h6>
                        <p class="text-secondary">{% if current_language == 'en' %}Modern hits{% else %}Hit moderni{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Interface & Prompt Builder -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100 animate-slide-up" style="animation-delay: 0.3s;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-3">
                    <i data-lucide="message-circle" class="me-3" style="width: 24px; height: 24px; color: var(--spotify-green);"></i>
                    <h3 class="card-title mb-0">{{ _('ai_lab.ai_generator') }}</h3>
                </div>
                
                <!-- Chat History -->
                <div class="chat-container flex-grow-1 mb-3" id="chatContainer">
                    <div class="chat-message assistant">
                        <div class="d-flex align-items-center mb-2">
                            <i data-lucide="bot" class="me-2" style="width: 16px; height: 16px;"></i>
                            <strong>{{ _('ai.bot_messages.ai_assistant') }}</strong>
                        </div>
                        <p class="mb-0">{{ _('ai.bot_messages.greeting') }}</p>
                        <div class="timestamp">{{ _('ai.bot_messages.now') }}</div>
                    </div>
                </div>
                
                <!-- Suggestion Pills -->
                <div class="mb-3" id="suggestionPills" style="display: none;">
                    <small class="text-secondary d-block mb-2">{{ _('ai.bot_messages.suggestions_prompt') }}</small>
                    <div class="suggestions-container"></div>
                </div>
                
                <!-- Prompt Input -->
                <form action="{{ url_for('ai_lab', user=selected_user) }}" method="post" id="promptForm">
                    <div class="prompt-input-container mb-3">
                        <textarea id="custom_prompt" name="custom_prompt" rows="3" class="form-control" 
                                  placeholder="{% if current_language == 'en' %}Describe the playlist you want... (e.g., energetic playlist for running with 90s rock){% else %}Descrivi la playlist che desideri... (es: playlist energica per correre con rock anni 90){% endif %}"
                                  style="resize: none;"></textarea>
                        <div class="prompt-suggestions" id="promptSuggestions"></div>
                    </div>
                    
                    <!-- Quick Modifiers -->
                    <div class="mb-3">
                        <small class="text-secondary d-block mb-2">{{ _('ai.bot_messages.customization_prompt') }}</small>
                        <div class="d-flex flex-wrap gap-1" id="modifierPills">
                            {% if current_language == 'en' %}
                                <span class="suggestion-pill" data-modifier="high energy">high energy</span>
                                <span class="suggestion-pill" data-modifier="chill vibes">chill vibes</span>
                                <span class="suggestion-pill" data-modifier="1 hour">1 hour</span>
                                <span class="suggestion-pill" data-modifier="only hits">only hits</span>
                                <span class="suggestion-pill" data-modifier="deep cuts">deep cuts</span>
                                <span class="suggestion-pill" data-modifier="underground">underground</span>
                                <span class="suggestion-pill" data-modifier="mix decades">mix decades</span>
                                <span class="suggestion-pill" data-modifier="discover new">discover new</span>
                            {% else %}
                                <span class="suggestion-pill" data-modifier="alta energia">alta energia</span>
                                <span class="suggestion-pill" data-modifier="atmosfera rilassante">atmosfera rilassante</span>
                                <span class="suggestion-pill" data-modifier="1 ora">1 ora</span>
                                <span class="suggestion-pill" data-modifier="solo hit">solo hit</span>
                                <span class="suggestion-pill" data-modifier="brani profondi">brani profondi</span>
                                <span class="suggestion-pill" data-modifier="underground">underground</span>
                                <span class="suggestion-pill" data-modifier="mix di decenni">mix di decenni</span>
                                <span class="suggestion-pill" data-modifier="scopri nuovi">scopri nuovi</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Charts Integration Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_charts" name="include_charts" checked>
                            <label class="form-check-label" for="include_charts">
                                <i data-lucide="trending-up" class="me-1" style="width: 16px; height: 16px; color: var(--spotify-green);"></i>
                                <strong>{{ _('ai.bot_messages.charts_integration') }}</strong>
                            </label>
                        </div>
                        <small class="text-muted">{{ _('ai.bot_messages.charts_description') }}</small>
                        
                        <!-- Track Count Field -->
                        <div class="mt-3">
                            <label for="track_count" class="form-label">
                                <i data-lucide="music" class="me-1" style="width: 16px; height: 16px; color: var(--accent-purple);"></i>
                                <strong>{% if current_language == 'en' %}Number of Tracks{% else %}Numero di Brani{% endif %}</strong>
                            </label>
                            <input type="number" class="form-control" id="track_count" name="track_count" 
                                   min="10" max="100" step="1" 
                                   placeholder="{% if current_language == 'en' %}Leave empty for default (30-40){% else %}Lascia vuoto per predefinito (30-40){% endif %}"
                                   style="max-width: 200px;">
                            <small class="text-muted">
                                {% if current_language == 'en' %}Specify 10-100 tracks. Empty = AI decides (30-40 tracks with more variety){% else %}Specifica 10-100 brani. Vuoto = l'AI decide (30-40 brani con pi√π variet√†){% endif %}
                            </small>
                        </div>
                        
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-info" id="previewChartsBtn">
                                <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                {{ _('ai.bot_messages.preview_charts') }}
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" id="testChartsBtn">
                                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                                {{ _('ai.bot_messages.test_integration') }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div id="progressContainer" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>
                                    <div class="fw-bold" id="progressTitle">{{ _('ai.bot_messages.generating_progress') }}</div>
                                    <small id="progressMessage">{{ _('ai.bot_messages.starting_ai') }}</small>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 d-flex align-items-center justify-content-center" id="generateBtn">
                        <i data-lucide="sparkles" class="me-2" style="width: 18px; height: 18px;"></i>
                        {{ _('ai.bot_messages.generate_button') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Existing Playlists -->
    <div class="col-lg-3 mb-4">
        <div class="card h-100 animate-slide-up" style="animation-delay: 0.4s;">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                        <i data-lucide="list-music" class="me-3" style="width: 24px; height: 24px; color: var(--accent-blue);"></i>
                        <h3 class="card-title mb-0">{{ _('ai.bot_messages.playlists_created') }}</h3>
                    </div>
                    <span class="badge bg-info">{{ existing_playlists|length }}</span>
                </div>
                
                {% if existing_playlists %}
                    <div class="playlist-timeline">
                        {% for playlist in existing_playlists %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1 me-2">
                                    <h6 class="fw-bold mb-1">{{ playlist.title }}</h6>
                                    {% if playlist.description %}
                                    <p class="text-secondary small mb-1">"{{ playlist.description[:50] }}{% if playlist.description|length > 50 %}...{% endif %}"</p>
                                    {% endif %}
                                    <div class="d-flex align-items-center text-muted">
                                        <i data-lucide="music" style="width: 12px; height: 12px;" class="me-1"></i>
                                        <small>{{ playlist.item_count }} tracce</small>
                                        <span class="mx-1">‚Ä¢</span>
                                        <small>{{ playlist.created_at_formatted }}</small>
                                    </div>
                                </div>
                                <form action="{{ url_for('delete_ai_playlist_route', playlist_db_id=playlist.id) }}" 
                                      method="post" 
                                      onsubmit="return confirm('{{ _('ai.bot_messages.delete_confirm') }}');"
                                      class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Elimina playlist">
                                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i data-lucide="music" style="width: 48px; height: 48px; color: var(--text-muted);" class="mb-3"></i>
                        <p class="text-secondary">{{ _('ai.bot_messages.no_playlists') }}</p>
                        <small class="text-muted">{{ _('ai.bot_messages.playlists_appear_here') }}</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Translations for JavaScript - hardcoded based on current language
    const translations = {
        {% if current_language == 'en' %}
        preset_selected_user: "I selected the preset: {preset}",
        preset_selected_assistant: "Perfect! I've prepared an optimized prompt for {preset}. You can modify it or generate the playlist directly.",
        suggestion_selected: "Great choice! This playlist will be perfect for your needs.",
        generating_playlist: "üéµ Perfect! I'm generating your personalized playlist. I'll monitor the progress...",
        waiting_scan: "‚è≥ Waiting 5 minutes to give Plex time to scan the new downloaded files...",
        playlist_success: "‚úÖ Playlist created and updated successfully! Check the tracks that were missing - they should now be in the playlist.",
        charts_preview_user: "Charts preview request",
        charts_loading: "üîÑ Loading music data...",
        charts_error: "‚ùå Error loading charts preview: {error}",
        charts_test_error: "‚ùå Error during charts test.",
        charts_data_error: "‚ùå Error loading charts data: {error}"
        {% else %}
        preset_selected_user: "Ho selezionato il preset: {preset}",
        preset_selected_assistant: "Perfetto! Ho preparato un prompt ottimizzato per {preset}. Puoi modificarlo o generare direttamente la playlist.",
        suggestion_selected: "Ottima scelta! Questa playlist sar√† perfetta per le tue esigenze.",
        generating_playlist: "üéµ Perfetto! Sto generando la tua playlist personalizzata. Monitorer√≤ il progresso...",
        waiting_scan: "‚è≥ Attendo 5 minuti per dare a Plex il tempo di scansionare i nuovi file scaricati...",
        playlist_success: "‚úÖ Playlist creata e aggiornata con successo! Controlla i brani che erano mancanti - dovrebbero ora essere presenti nella playlist.",
        charts_preview_user: "Richiesta anteprima classifiche",
        charts_loading: "üîÑ Caricamento dati musicali in corso...",
        charts_error: "‚ùå Errore nel caricamento anteprima classifiche: {error}",
        charts_test_error: "‚ùå Errore durante il test delle classifiche.",
        charts_data_error: "‚ùå Errore nel caricamento dati classifiche: {error}"
        {% endif %}
    };
    
    let selectedPreset = null;
    let activeSuggestions = [];
    
    // Preset data with enhanced prompts
    const presetPrompts = {
        {% if current_language == 'en' %}
        'energia': 'Create an energetic 25-track playlist perfect for gym workouts. Include alternative rock, energetic pop and electronic dance music. Prioritize tracks with fast tempo (130+ BPM) and motivational lyrics.',
        'relax': 'Generate a relaxing 20-track playlist for meditation and relaxation. Include ambient, acoustic, indie folk and instrumental music. Choose tracks with calming atmospheres and gentle melodies.',
        'focus': 'Create a focus playlist of 20 tracks perfect for studying and working. Include ambient instrumental, lo-fi hip-hop, classical and minimal electronic music for concentration.',
        'party': 'Create a party playlist of 30 tracks with the best dancefloor hits. Include pop dance, house music, reggaeton and party anthems. Perfect for getting everyone dancing!',
        'jazz': 'Generate a sophisticated jazz playlist of 25 tracks. Include smooth jazz, bebop, swing and contemporary jazz from Miles Davis to modern artists.',
        '80s-90s': 'Create a nostalgic playlist with 30 hits from the 80s and 90s. Include synth-pop, rock, dance and the biggest songs that defined those decades.',
        'rock-classics': 'Generate a playlist with 25 classic rock hits of all time. Include Led Zeppelin, Queen, AC/DC, Pink Floyd, Deep Purple and other rock legends. Only great hits!',
        'italian-music': 'Create a playlist with 25 tracks of the best Italian music. Include singer-songwriters, Italian pop, Italian rock and great classics from Battisti to Vasco Rossi.',
        'electronic': 'Generate an electronic playlist of 20 tracks with house, techno, progressive and EDM. Include both classics and modern tracks from the electronic scene.',
        '1960s': 'Create a \'60s playlist with rock \'n\' roll, Motown, folk rock and psychedelic. Include Beatles, Rolling Stones, Supremes and Bob Dylan who revolutionized music.',
        '1970s': 'Generate a \'70s playlist with disco, funk, progressive rock and glam. Include Pink Floyd, Donna Summer, Parliament-Funkadelic and David Bowie to capture the essence of the decade.',
        '1980s': 'Create an \'80s playlist with synth-pop, new wave, post-punk and early hip-hop. Include Depeche Mode, Duran Duran, The Cure and Run-DMC for the MTV atmosphere of the era.',
        '1990s': 'Generate a \'90s playlist with grunge, alternative rock, hip-hop and R&B. Include Nirvana, Radiohead, Tupac and Whitney Houston who defined the sound of the decade.',
        '2000s': 'Create a 2000s playlist with pop-punk, emo, nu-metal and R&B. Include Green Day, My Chemical Romance, Linkin Park and Beyonc√© for the energy of the new millennium.',
        '2010s': 'Generate a 2010s playlist with EDM, indie folk, pop and trap. Include Avicii, Mumford & Sons, Taylor Swift and Drake who dominated the streaming era.',
        '2020s': 'Create a 2020s playlist with hyperpop, bedroom pop, drill and contemporary pop. Include 100 gecs, Clairo, emerging artists and the new sounds of generation Z.'
        {% else %}
        'energia': 'Crea una playlist energica di 25 brani perfetta per allenarsi in palestra. Include rock alternativo, pop energico e electronic dance music. Privilegia brani con un ritmo veloce (130+ BPM) e testi motivazionali.',
        'relax': 'Genera una playlist rilassante di 20 brani per meditazione e relax. Include ambient, acoustic, indie folk e musica strumentale. Scegli brani con atmosfere calmanti e melodie dolci.',
        'focus': 'Crea una playlist per la concentrazione di 20 brani perfetta per studiare e lavorare. Include strumentale ambient, lo-fi hip-hop, classica e electronic minimale per la concentrazione.',
        'party': 'Crea una playlist da festa di 30 brani con i migliori hit dancefloor. Include pop dance, house music, reggaeton e tormentoni italiani. Perfetta per far ballare tutti!',
        'jazz': 'Genera una playlist jazz sofisticata di 25 brani. Include smooth jazz, bebop, swing e jazz contemporaneo da Miles Davis agli artisti moderni.',
        '80s-90s': 'Crea una playlist nostalgica con 30 hit degli anni 80 e 90. Include synth-pop, rock, dance e le pi√π grandi canzoni che hanno definito quei decenni.',
        'rock-classics': 'Genera una playlist con 25 classici del rock di tutti i tempi. Include Led Zeppelin, Queen, AC/DC, Pink Floyd, Deep Purple e altre leggende del rock. Solo grandi successi!',
        'italian-music': 'Crea una playlist con 25 brani del meglio della musica italiana. Include cantautori, pop italiano, rock italiano e grandi classici da Battisti a Vasco Rossi.',
        'electronic': 'Genera una playlist elettronica di 20 brani con house, techno, progressive e EDM. Include sia classici che brani moderni del panorama electronic.',
        '1960s': 'Crea una playlist anni \'60 con rock \'n\' roll, Motown, folk rock e psychedelic. Include Beatles, Rolling Stones, Supremes e Bob Dylan che hanno rivoluzionato la musica.',
        '1970s': 'Genera una playlist anni \'70 con disco, funk, progressive rock e glam. Include Pink Floyd, Donna Summer, Parliament-Funkadelic e David Bowie per catturare l\'essenza del decennio.',
        '1980s': 'Crea una playlist anni \'80 con synth-pop, new wave, post-punk e early hip-hop. Include Depeche Mode, Duran Duran, The Cure e Run-DMC per l\'atmosfera MTV dell\'epoca.',
        '1990s': 'Genera una playlist anni \'90 con grunge, alternative rock, hip-hop e R&B. Include Nirvana, Radiohead, Tupac e Whitney Houston che hanno definito il sound del decennio.',
        '2000s': 'Crea una playlist anni 2000 con pop-punk, emo, nu-metal e R&B. Include Green Day, My Chemical Romance, Linkin Park e Beyonc√© per l\'energia del nuovo millennio.',
        '2010s': 'Genera una playlist anni 2010 con EDM, indie folk, pop e trap. Include Avicii, Mumford & Sons, Taylor Swift e Drake che hanno dominato l\'era dello streaming.',
        '2020s': 'Crea una playlist anni 2020 con hyperpop, bedroom pop, drill e pop contemporaneo. Include 100 gecs, Clairo, artisti emergenti e i nuovi suoni della generazione Z.'
        {% endif %}
    };
    
    // Intelligent suggestions based on context
    const contextualSuggestions = {
        {% if current_language == 'en' %}
        workout: ['high BPM tracks', 'energetic rock', 'electronic dance', 'motivational rap'],
        mood: ['relaxing atmosphere', 'emotional tracks', 'positive music', 'chill sounds'],
        party: ['disco hits', 'danceable music', 'summer anthems', 'reggaeton hits'],
        discovery: ['little known tracks', 'emerging artists', 'hidden gems', 'deep cuts'],
        classics: ['greatest hits', 'evergreen', 'timeless classics', 'greatest hits']
        {% else %}
        workout: ['brani ad alto BPM', 'rock energico', 'electronic dance', 'rap motivazionale'],
        mood: ['atmosfera rilassante', 'brani emotivi', 'musica positiva', 'sonorit√† chill'],
        party: ['hit da discoteca', 'musica ballabile', 'tormentoni estate', 'reggaeton hits'],
        discovery: ['brani poco conosciuti', 'artisti emergenti', 'hidden gems', 'deep cuts'],
        classics: ['grandi successi', 'evergreen', 'classici intramontabili', 'greatest hits']
        {% endif %}
    };
    
    // Initialize
    setupPresetTabs();
    setupPresetHandlers();
    setupPromptAutocomplete();
    setupModifierPills();
    setupChartsIntegration();
    
    function setupPresetTabs() {
        $('.preset-tab').on('click', function() {
            const category = $(this).data('category');
            
            // Update tab appearance
            $('.preset-tab').removeClass('active');
            $(this).addClass('active');
            
            // Hide all preset grids
            $('.preset-grid').hide();
            
            // Show selected category grid
            $('#' + category + '-presets').show();
        });
    }
    
    function setupPresetHandlers() {
        $('.preset-card-compact').on('click', function() {
            const preset = $(this).data('preset');
            const category = $(this).data('category');
            
            // Visual feedback
            $('.preset-card-compact').removeClass('selected');
            $(this).addClass('selected');
            
            selectedPreset = preset;
            
            // Update prompt
            const promptText = presetPrompts[preset];
            $('#custom_prompt').val(promptText);
            
            // Add to chat
            const presetName = $(this).find('h6').text();
            addChatMessage('user', translations.preset_selected_user.replace('{preset}', presetName));
            addChatMessage('assistant', translations.preset_selected_assistant.replace('{preset}', presetName.toLowerCase()));
            
            // Show contextual suggestions
            showContextualSuggestions(category, preset);
            
            // Scroll to prompt
            $('html, body').animate({
                scrollTop: $('#custom_prompt').offset().top - 100
            }, 500);
        });
    }
    
    function setupPromptAutocomplete() {
        const commonPrompts = [
            'playlist per allenarsi con rock energico',
            'musica rilassante per studiare',
            'hit italiane per cantare in auto',
            'brani romantici per cena',
            'musica da festa anni 90',
            'colonna sonora per lavorare',
            'classici rock per viaggio',
            'electronic music per concentrarsi'
        ];
        
        $('#custom_prompt').on('input', function() {
            const input = $(this).val().toLowerCase();
            const suggestions = commonPrompts.filter(prompt => 
                prompt.toLowerCase().includes(input) && input.length > 2
            );
            
            if (suggestions.length > 0 && input.length > 2) {
                showPromptSuggestions(suggestions);
            } else {
                hidePromptSuggestions();
            }
        });
        
        // Hide suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.prompt-input-container').length) {
                hidePromptSuggestions();
            }
        });
    }
    
    function showPromptSuggestions(suggestions) {
        const container = $('#promptSuggestions');
        container.empty();
        
        suggestions.forEach(suggestion => {
            const item = $(`<div class="suggestion-item">${suggestion}</div>`);
            item.on('click', function() {
                $('#custom_prompt').val(suggestion);
                hidePromptSuggestions();
                addChatMessage('user', suggestion);
                addChatMessage('assistant', translations.suggestion_selected);
            });
            container.append(item);
        });
        
        container.show();
    }
    
    function hidePromptSuggestions() {
        $('#promptSuggestions').hide();
    }
    
    function setupModifierPills() {
        $('#modifierPills .suggestion-pill').on('click', function() {
            $(this).toggleClass('active');
            
            // Add modifier to prompt
            const modifier = $(this).data('modifier');
            const currentPrompt = $('#custom_prompt').val();
            
            if ($(this).hasClass('active')) {
                if (!currentPrompt.includes(modifier)) {
                    const newPrompt = currentPrompt + (currentPrompt ? ', ' : '') + modifier;
                    $('#custom_prompt').val(newPrompt);
                }
            } else {
                const newPrompt = currentPrompt.replace(new RegExp(',?\\s*' + modifier, 'g'), '');
                $('#custom_prompt').val(newPrompt);
            }
        });
    }
    
    function showContextualSuggestions(category, preset) {
        const suggestions = getContextualSuggestions(category, preset);
        if (suggestions.length > 0) {
            const container = $('#suggestionPills .suggestions-container');
            container.empty();
            
            suggestions.forEach(suggestion => {
                const pill = $(`<span class="suggestion-pill">${suggestion}</span>`);
                pill.on('click', function() {
                    const currentPrompt = $('#custom_prompt').val();
                    const newPrompt = currentPrompt + ', ' + suggestion;
                    $('#custom_prompt').val(newPrompt);
                    $(this).addClass('active');
                });
                container.append(pill);
            });
            
            $('#suggestionPills').show();
        }
    }
    
    function getContextualSuggestions(category, preset) {
        switch(category) {
            case 'mood':
                if (preset === 'energia') return contextualSuggestions.workout;
                if (preset === 'relax') return contextualSuggestions.mood;
                if (preset === 'party') return contextualSuggestions.party;
                break;
            case 'genre':
                return contextualSuggestions.discovery;
            case 'era':
                return contextualSuggestions.classics;
        }
        return [];
    }
    
    function addChatMessage(sender, message) {
        const timestamp = new Date().toLocaleTimeString('it-IT', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const messageHtml = sender === 'user' ? 
            `<div class="chat-message user">
                <div>${message}</div>
                <div class="timestamp">${timestamp}</div>
             </div>` :
            `<div class="chat-message assistant">
                <div class="d-flex align-items-center mb-2">
                    <i data-lucide="bot" class="me-2" style="width: 16px; height: 16px;"></i>
                    <strong>AI Assistant</strong>
                </div>
                <div>${message}</div>
                <div class="timestamp">${timestamp}</div>
             </div>`;
        
        $('#chatContainer').append(messageHtml);
        
        // Refresh icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Scroll to bottom
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Form submission enhancement with progress tracking
    $('#promptForm').on('submit', function(e) {
        const prompt = $('#custom_prompt').val().trim();
        if (prompt) {
            addChatMessage('user', prompt);
            addChatMessage('assistant', translations.generating_playlist);
            
            // Show progress and disable button
            showProgress();
            startProgressMonitoring();
        }
    });
    
    function showProgress() {
        $('#progressContainer').show();
        $('#generateBtn').prop('disabled', true);
        $('#generateBtn').html('<div class="spinner-border spinner-border-sm me-2"></div>Generazione in corso...');
    }
    
    function hideProgress() {
        $('#progressContainer').hide();
        $('#generateBtn').prop('disabled', false);
        $('#generateBtn').html('<i data-lucide="sparkles" class="me-2" style="width: 18px; height: 18px;"></i>Genera Playlist con AI');
        lucide.createIcons();
    }
    
    function updateProgress(step, message, percentage) {
        $('#progressTitle').text(step);
        $('#progressMessage').text(message);
        $('#progressBar').css('width', percentage + '%');
    }
    
    function startProgressMonitoring() {
        const steps = [
            { step: "Connessione AI...", message: "Invio richiesta a Gemini", percent: 5, duration: 8000 },
            { step: "Generazione playlist...", message: "AI sta creando la selezione", percent: 15, duration: 12000 },
            { step: "Ricerca tracce...", message: "Verifica disponibilit√† nella libreria", percent: 25, duration: 15000 },
            { step: "Download mancanti...", message: "Scaricamento brani non presenti", percent: 60, duration: 120000 }, // 2 minuti
            { step: "Attesa scansione Plex...", message: "Plex sta indicizzando i nuovi file", percent: 75, duration: 300000 }, // 5 minuti
            { step: "Aggiornamento playlist...", message: "Verifica tracce e aggiornamento automatico", percent: 90, duration: 30000 },
            { step: "Completamento...", message: "Processo completato con successo", percent: 100, duration: 5000 }
        ];
        
        let currentStep = 0;
        
        function processNextStep() {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                updateProgress(step.step, step.message, step.percent);
                
                // Aggiungi messaggio specifico per l'attesa
                if (currentStep === 4) { // Attesa scansione Plex
                    addChatMessage('assistant', translations.waiting_scan);
                }
                
                currentStep++;
                
                if (currentStep === steps.length) {
                    setTimeout(() => {
                        checkForNewPlaylist();
                        hideProgress();
                        addChatMessage('assistant', translations.playlist_success);
                    }, step.duration);
                } else {
                    setTimeout(processNextStep, step.duration);
                }
            }
        }
        
        processNextStep();
    }
    
    function checkForNewPlaylist() {
        // Show badge in navbar for new playlist
        if (typeof window.showNewPlaylistBadge === 'function') {
            window.showNewPlaylistBadge();
        }
        
        setTimeout(() => {
            location.reload(); // Refresh to show new playlist in sidebar
        }, 1000);
    }
    
    function setupChartsIntegration() {
        // Preview Charts button
        $('#previewChartsBtn').on('click', function() {
            $(this).prop('disabled', true).html('<div class="spinner-border spinner-border-sm me-1"></div>Caricamento...');
            
            // Add immediate feedback
            addChatMessage('user', translations.charts_preview_user);
            addChatMessage('assistant', translations.charts_loading);
            
            $.get('/api/music_charts_preview')
                .done(function(data) {
                    console.log('Charts data received:', data);
                    showChartsPreview(data);
                })
                .fail(function(xhr, status, error) {
                    console.error('Charts API error:', xhr, status, error);
                    addChatMessage('assistant', translations.charts_error.replace('{error}', error));
                })
                .always(function() {
                    $('#previewChartsBtn').prop('disabled', false).html('<i data-lucide="eye" style="width: 14px; height: 14px;"></i> Anteprima Classifiche');
                    lucide.createIcons();
                });
        });
        
        // Test Charts Integration button
        $('#testChartsBtn').on('click', function() {
            $(this).prop('disabled', true).html('<div class="spinner-border spinner-border-sm me-1"></div>Testing...');
            
            $.get('/api/test_music_charts')
                .done(function(data) {
                    const message = data.success ? 
                        '‚úÖ Test completato con successo! Tutte le fonti di classifiche sono funzionanti.' :
                        '‚ùå Test fallito. Verificare la configurazione delle classifiche.';
                    addChatMessage('assistant', message);
                })
                .fail(function() {
                    addChatMessage('assistant', translations.charts_test_error);
                })
                .always(function() {
                    $('#testChartsBtn').prop('disabled', false).html('<i data-lucide="check-circle" style="width: 14px; height: 14px;"></i> Test Integrazione');
                    lucide.createIcons();
                });
        });
    }
    
    function showChartsPreview(data) {
        if (data.error) {
            addChatMessage('assistant', translations.charts_data_error.replace('{error}', data.error));
            return;
        }
        
        let message = 'üìä ANTEPRIMA CLASSIFICHE DISPONIBILI:\n\n';
        
        // Charts
        if (data.charts_available && data.charts_available.length > 0) {
            message += 'CLASSIFICHE PRINCIPALI:\n';
            data.charts_available.forEach(chart => {
                message += `‚Ä¢ ${chart.name}: ${chart.count} tracce\n`;
                if (chart.top_3) {
                    chart.top_3.forEach((track, i) => {
                        message += `  ${i+1}. ${track.artist} - ${track.title}\n`;
                    });
                }
                message += '\n';
            });
        }
        
        // Trends
        if (data.trends_available && data.trends_available.length > 0) {
            message += 'TENDENZE MUSICALI:\n';
            data.trends_available.forEach(trend => {
                message += `‚Ä¢ ${trend.name}: ${trend.count} brani\n`;
            });
            message += '\n';
        }
        
        // News
        if (data.news_count > 0) {
            message += `NOTIZIE MUSICALI: ${data.news_count} articoli disponibili\n\n`;
        }
        
        message += `Ultimo aggiornamento: ${new Date(data.timestamp).toLocaleString('it-IT')}`;
        
        addChatMessage('assistant', message);
    }
    
    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
