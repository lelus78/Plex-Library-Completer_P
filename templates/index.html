{% extends 'base.html' %}
{% block title %}{{ _('dashboard.title') }}{% endblock %}

{% block content %}
<!-- Status Cards Row -->
<div class="row mb-4">
    <!-- System Status Card -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100 animate-slide-up">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i data-lucide="activity" class="me-3" style="width: 28px; height: 28px; color: var(--spotify-green);"></i>
                    <h2 class="card-title mb-0">{{ _('dashboard.system_sync') }}</h2>
                </div>
                
                <!-- Status Display -->
                <div class="text-center mb-4 p-4" style="background: var(--gradient-card); border-radius: var(--radius-md);">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i data-lucide="circle" id="status-icon" class="me-2" style="width: 16px; height: 16px;"></i>
                        <p class="fs-4 fw-bold mb-0" id="status-text">{{ _('common.loading') }}</p>
                    </div>
                    <small class="text-secondary" id="last-sync-time">{{ _('dashboard.logs.loading') }}</small>
                </div>
                
                <!-- Sync Options -->
                <div class="mb-4 p-3" style="background: var(--gradient-card); border-radius: var(--radius-md);">
                    <div class="d-flex align-items-center mb-3">
                        <i data-lucide="settings" class="me-2" style="width: 20px; height: 20px; color: var(--accent-blue);"></i>
                        <h6 class="mb-0 fw-medium">{{ _('dashboard.sync_options.title') }}</h6>
                    </div>
                    
                    <form id="sync-options-form" action="{{ url_for('sync_selective') }}" method="post">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_spotify" name="enable_spotify" checked>
                                    <label class="form-check-label d-flex align-items-center" for="enable_spotify">
                                        <i data-lucide="music" class="me-2" style="width: 16px; height: 16px; color: var(--spotify-green);"></i>
                                        {{ _('dashboard.sync_options.spotify') }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_deezer" name="enable_deezer" checked>
                                    <label class="form-check-label d-flex align-items-center" for="enable_deezer">
                                        <i data-lucide="disc-3" class="me-2" style="width: 16px; height: 16px; color: var(--deezer-orange, #ff5500);"></i>
                                        {{ _('dashboard.sync_options.deezer') }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_ai" name="enable_ai" checked>
                                    <label class="form-check-label d-flex align-items-center" for="enable_ai">
                                        <i data-lucide="brain" class="me-2" style="width: 16px; height: 16px; color: var(--accent-purple);"></i>
                                        {{ _('dashboard.sync_options.ai_playlists') }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_discovery" name="auto_discovery">
                                    <label class="form-check-label d-flex align-items-center" for="auto_discovery">
                                        <i data-lucide="search" class="me-2" style="width: 16px; height: 16px; color: var(--accent-blue);"></i>
                                        {{ _('dashboard.sync_options.auto_discovery') }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Configuration Warnings -->
                    <div id="config-warnings" class="mt-3" style="display: none;">
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i data-lucide="alert-triangle" class="me-2" style="width: 16px; height: 16px;"></i>
                            <div>
                                <strong>⚠️ Auto-scoperta non disponibile</strong><br>
                                <small id="config-warning-text"></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <button id="btn-sync" type="button" onclick="submitSyncForm()" class="btn btn-primary w-100 d-flex align-items-center justify-content-center">
                            <i data-lucide="refresh-cw" class="me-2" style="width: 18px; height: 18px;"></i>
                            {{ _('dashboard.actions.sync_now') }}
                        </button>
                    </div>
                    <div class="col-md-6">
                        <form action="{{ url_for('cleanup_now') }}" method="post">
                            <button id="btn-cleanup" type="submit" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center">
                                <i data-lucide="trash-2" class="me-2" style="width: 18px; height: 18px;"></i>
                                {{ _('dashboard.actions.cleanup_only') }}
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Stop Button (only shown when operation is running) -->
                <div class="row g-3 mt-2" id="stop-button-container" style="display: none;">
                    <div class="col-12">
                        <button id="btn-stop" type="button" class="btn btn-danger w-100 d-flex align-items-center justify-content-center">
                            <i data-lucide="square" class="me-2" style="width: 18px; height: 18px;"></i>
                            {{ _('dashboard.actions.stop_operation') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users & Maintenance Card -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <i data-lucide="users" class="me-3" style="width: 24px; height: 24px; color: var(--accent-blue);"></i>
                    <h3 class="card-title mb-0">{{ _('dashboard.users.managed_users') }}</h3>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex align-items-center p-3 mb-2" style="background: var(--gradient-card); border-radius: var(--radius-md); border-left: 3px solid var(--spotify-green);">
                        <i data-lucide="user" class="me-3" style="width: 20px; height: 20px; color: var(--spotify-green);"></i>
                        <span class="fw-medium">{{ aliases.main }}</span>
                    </div>
                    <div class="d-flex align-items-center p-3" style="background: var(--gradient-card); border-radius: var(--radius-md); border-left: 3px solid var(--accent-purple);">
                        <i data-lucide="user" class="me-3" style="width: 20px; height: 20px; color: var(--accent-purple);"></i>
                        <span class="fw-medium">{{ aliases.secondary }}</span>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="d-flex align-items-center mb-3">
                        <i data-lucide="settings" class="me-3" style="width: 20px; height: 20px; color: var(--accent-yellow);"></i>
                        <h4 class="mb-0">{{ _('dashboard.users.maintenance') }}</h4>
                    </div>
                    
                    {% if index_stats.total_tracks_indexed == 0 %}
                    <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                        <i data-lucide="alert-triangle" class="me-2" style="width: 20px; height: 20px;"></i>
                        <div>
                            <strong>⚠️ {{ _('dashboard.alerts.index_empty') }}</strong><br>
                            <small>{{ _('dashboard.alerts.index_empty_desc') }}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                        <i data-lucide="check-circle" class="me-2" style="width: 20px; height: 20px;"></i>
                        <div>
                            <strong>✅ {{ _('dashboard.alerts.index_ok') }}</strong><br>
                            <small>{{ index_stats.total_tracks_indexed }} {{ _('status_messages.tracks_indexed') }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <p class="text-secondary small mb-3">
                        {{ _('dashboard.index_description') }}
                        <span class="text-warning fw-medium">{{ _('dashboard.alerts.operation_slow') }}</span> - {{ _('dashboard.alerts.only_if_needed') }}.
                    </p>
                    <div class="d-grid gap-2">
                        <form action="{{ url_for('build_index_route') }}" method="post">
                            <button id="btn-index" type="submit" class="btn {% if index_stats.total_tracks_indexed == 0 %}btn-warning{% else %}btn-secondary{% endif %} w-100 d-flex align-items-center justify-content-center">
                                <i data-lucide="database" class="me-2" style="width: 16px; height: 16px;"></i>
                                {{ _('dashboard.actions.build_index') }}
                            </button>
                        </form>
                        
                        {% if index_stats.total_tracks_indexed == 0 %}
                        <form action="{{ url_for('restart_indexing') }}" method="post">
                            <button type="submit" class="btn btn-outline-success btn-sm w-100 d-flex align-items-center justify-content-center">
                                <i data-lucide="rotate-cw" class="me-2" style="width: 14px; height: 14px;"></i>
                                🔄 {{ _('dashboard.actions.restart_indexing') }}
                            </button>
                        </form>
                        <form action="{{ url_for('test_database') }}" method="post">
                            <button type="submit" class="btn btn-outline-info btn-sm w-100 d-flex align-items-center justify-content-center">
                                <i data-lucide="activity" class="me-2" style="width: 14px; height: 14px;"></i>
                                🔧 {{ _('dashboard.actions.test_database') }}
                            </button>
                        </form>
                        <form action="{{ url_for('emergency_cleanup') }}" method="post" onsubmit="return confirm('{{ _('messages.confirm_cleanup') }}');"
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100 d-flex align-items-center justify-content-center">
                                <i data-lucide="alert-triangle" class="me-2" style="width: 14px; height: 14px;"></i>
                                🚨 {{ _('dashboard.actions.emergency_cleanup') }}
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row mb-4">
    <div class="col-lg mb-3">
        <div class="card text-center animate-slide-up" style="animation-delay: 0.2s;">
            <div class="card-body py-4">
                <i data-lucide="music" class="mb-3" style="width: 32px; height: 32px; color: var(--spotify-green);"></i>
                <h5 class="card-title mb-1">{{ _('dashboard.stats.tracks_synced') }}</h5>
                <p class="fs-3 fw-bold text-primary mb-0" id="tracks-count">-</p>
            </div>
        </div>
    </div>
    <div class="col-lg mb-3">
        <div class="card text-center animate-slide-up" style="animation-delay: 0.25s;">
            <div class="card-body py-4">
                <i data-lucide="list" class="mb-3" style="width: 32px; height: 32px; color: var(--accent-blue);"></i>
                <h5 class="card-title mb-1" style="font-size: 0.9rem;">Playlist Selezionate</h5>
                <p class="fs-3 fw-bold text-info mb-0" id="selected-playlists-count" data-bs-toggle="tooltip" title="Click per dettagli" style="cursor: pointer;">-</p>
                <small class="text-muted" id="selected-playlists-breakdown" style="font-size: 0.75rem;"></small>
            </div>
        </div>
    </div>
    <div class="col-lg mb-3">
        <div class="card text-center animate-slide-up" style="animation-delay: 0.3s;">
            <div class="card-body py-4">
                <i data-lucide="search" class="mb-3" style="width: 32px; height: 32px; color: var(--accent-red);"></i>
                <h5 class="card-title mb-1">{{ _('dashboard.stats.missing_tracks') }}</h5>
                <p class="fs-3 fw-bold text-warning mb-0" id="missing-count">-</p>
            </div>
        </div>
    </div>
    <div class="col-lg mb-3">
        <div class="card text-center animate-slide-up" style="animation-delay: 0.4s;">
            <div class="card-body py-4">
                <i data-lucide="brain" class="mb-3" style="width: 32px; height: 32px; color: var(--accent-purple);"></i>
                <h5 class="card-title mb-1">{{ _('dashboard.stats.ai_playlists') }}</h5>
                <p class="fs-3 fw-bold text-info mb-0" id="ai-playlists-count">-</p>
            </div>
        </div>
    </div>
    <div class="col-lg mb-3">
        <div class="card text-center animate-slide-up" style="animation-delay: 0.5s;">
            <div class="card-body py-4">
                <i data-lucide="clock" class="mb-3" style="width: 32px; height: 32px; color: var(--accent-blue);"></i>
                <h5 class="card-title mb-1">{{ _('dashboard.stats.last_sync') }}</h5>
                <p class="fs-6 fw-medium mb-0" id="last-sync-short">-</p>
            </div>
        </div>
    </div>
</div>

<!-- System Logs Card -->
<div class="card animate-slide-up" style="animation-delay: 0.6s;">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <i data-lucide="terminal" class="me-3" style="width: 24px; height: 24px; color: var(--text-secondary);"></i>
                <h3 class="card-title mb-0">{{ _('dashboard.logs.system_logs') }}</h3>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2">{{ _('dashboard.logs.auto_refresh') }}</span>
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" style="width: 12px; height: 12px; color: var(--spotify-green);" role="status"></div>
                    <small class="text-secondary">{{ _('status_messages.every_15s') }}</small>
                </div>
            </div>
        </div>
        <div class="position-relative">
            <div class="p-3 rounded-3" style="height: 350px; overflow-y: auto; background: var(--bg-secondary); font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 0.85em; border: 1px solid rgba(255,255,255,0.1);">
                <code id="log-content" class="text-light">{{ _('dashboard.logs.loading') }}</code>
            </div>
            <!-- Fade overlay for better readability -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, var(--bg-secondary)); pointer-events: none; border-radius: 0 0 var(--radius-md) var(--radius-md);"></div>
        </div>
    </div>
</div>

<script>
    function updateDashboard() {
        fetch("{{ url_for('get_logs') }}")
            .then(response => response.json())
            .then(data => {
                // Update logs
                document.getElementById('log-content').innerText = data.logs;
                
                // Update status with animations and icons
                const statusText = document.getElementById('status-text');
                const statusIcon = document.getElementById('status-icon');
                
                statusText.innerText = data.status;
                statusText.className = 'fs-4 fw-bold mb-0';
                
                // Update status styling and icon based on state
                if (data.status.includes('Errore')) {
                    statusText.classList.add('text-danger');
                    statusIcon.setAttribute('data-lucide', 'alert-circle');
                    statusIcon.style.color = 'var(--accent-red)';
                } else if (data.status.includes('corso')) {
                    statusText.classList.add('text-warning');
                    statusIcon.setAttribute('data-lucide', 'loader');
                    statusIcon.style.color = 'var(--accent-yellow)';
                    statusIcon.classList.add('pulse');
                } else {
                    statusText.classList.add('text-success');
                    statusIcon.setAttribute('data-lucide', 'check-circle');
                    statusIcon.style.color = 'var(--spotify-green)';
                    statusIcon.classList.remove('pulse');
                }
                
                // Update sync time with translation
                const lastSyncLabel = '{{ _('dashboard.stats.last_sync') }}';
                document.getElementById('last-sync-time').innerText = lastSyncLabel + ': ' + data.last_sync;
                document.getElementById('last-sync-short').innerText = data.last_sync;

                // Update buttons with better UX
                const buttons = document.querySelectorAll('.btn');
                const runningText = '{{ _('status_messages.running') }}';
                const originalTexts = {
                    'btn-sync': '{{ _('dashboard.actions.sync_now') }}',
                    'btn-cleanup': '{{ _('dashboard.actions.cleanup_only') }}',
                    'btn-index': '{{ _('dashboard.actions.build_index') }}'
                };

                buttons.forEach(button => {
                    const isRunning = data.is_running;
                    if (button.id !== 'btn-stop') {  // Don't disable stop button
                        button.disabled = isRunning;
                        
                        if (isRunning) {
                            button.innerHTML = `<i data-lucide="loader" class="me-2" style="width: 16px; height: 16px;"></i>${runningText}`;
                            button.classList.add('pulse');
                        } else {
                            const originalText = originalTexts[button.id];
                            if (originalText) {
                                button.innerHTML = button.innerHTML.replace(runningText, originalText);
                            }
                            button.classList.remove('pulse');
                        }
                    }
                });
                
                // Show/hide stop button based on operation state
                const stopContainer = document.getElementById('stop-button-container');
                if (data.is_running) {
                    stopContainer.style.display = 'block';
                } else {
                    stopContainer.style.display = 'none';
                }
                
                // Refresh icons after content update
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                // Simulate stats update (you can replace with real API calls)
                updateStats();
            })
            .catch(error => {
                console.error('{{ _('status_messages.console_error') }}', error);
                // Show error state
                const statusText = document.getElementById('status-text');
                const statusIcon = document.getElementById('status-icon');
                statusText.innerText = '{{ _('errors.connection_error') }}';
                statusText.className = 'fs-4 fw-bold mb-0 text-danger';
                statusIcon.setAttribute('data-lucide', 'wifi-off');
                statusIcon.style.color = 'var(--accent-red)';
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
    }
    
    function updateStats() {
        // Fetch real stats from API
        fetch('/api/stats')
            .then(response => {
                console.log('Stats API response status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Stats API error:', data.error);
                    return;
                }
                
                console.log('Raw stats data:', data);
                
                // Animate library stats
                animateNumber('tracks-count', data.library.total_tracks);
                animateNumber('missing-count', data.missing_tracks.total);
                animateNumber('ai-playlists-count', data.ai_playlists.total);
                
                // Update sync health indicator
                updateSyncHealth(data.library.sync_health, data.missing_tracks.total);
                
                // Update selected playlists count
                updateSelectedPlaylistsCount();
                
                // Log stats for debugging
                console.log('Stats updated successfully - tracks:', data.library.total_tracks);
            })
            .catch(error => {
                console.error('Error fetching stats:', error);
                // Fallback to mock data
                const mockStats = {
                    tracks: 0,
                    missing: 0,
                    aiPlaylists: 0
                };
                animateNumber('tracks-count', mockStats.tracks);
                animateNumber('missing-count', mockStats.missing);
                animateNumber('ai-playlists-count', mockStats.aiPlaylists);
            });
    }
    
    function updateSyncHealth(health, missingCount) {
        const healthIndicator = document.querySelector('#status-icon');
        if (!healthIndicator) return;
        
        const statusText = document.querySelector('#status-text');
        
        switch(health) {
            case 'excellent':
                healthIndicator.style.color = 'var(--spotify-green)';
                if (statusText && statusText.innerText.includes('In attesa')) {
                    statusText.classList.remove('text-warning', 'text-danger');
                    statusText.classList.add('text-success');
                }
                break;
            case 'good':
                healthIndicator.style.color = 'var(--accent-yellow)';
                break;
            case 'needs_attention':
                healthIndicator.style.color = 'var(--accent-red)';
                break;
        }
    }
    
    function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const currentValue = parseInt(element.innerText) || 0;
        const increment = (targetValue - currentValue) / 20;
        let current = currentValue;
        
        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
                current = targetValue;
                clearInterval(timer);
            }
            element.innerText = Math.floor(current);
        }, 50);
    }
    
    function updateSelectedPlaylistsCount() {
        fetch('/api/selected_playlists_count')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const countData = data.data;
                    const totalCount = countData.total;
                    
                    // Update main count with animation
                    animateNumber('selected-playlists-count', totalCount);
                    
                    // Create breakdown text
                    let breakdownText = '';
                    if (countData.breakdown && Object.keys(countData.breakdown).length > 0) {
                        const userParts = [];
                        for (const [userType, services] of Object.entries(countData.breakdown)) {
                            const userTotal = countData.user_totals[userType] || 0;
                            const userLabel = userType === 'main' ? 'Main' : 'Secondary';
                            userParts.push(`${userLabel}: ${userTotal}`);
                        }
                        breakdownText = userParts.join(' | ');
                    } else {
                        breakdownText = 'Nessuna playlist selezionata';
                    }
                    
                    document.getElementById('selected-playlists-breakdown').innerText = breakdownText;
                    
                    // Update color based on count
                    const countElement = document.getElementById('selected-playlists-count');
                    if (totalCount === 0) {
                        countElement.className = 'fs-3 fw-bold text-warning mb-0';
                        countElement.style.cursor = 'pointer';
                    } else if (totalCount > 20) {
                        countElement.className = 'fs-3 fw-bold text-danger mb-0';
                        countElement.style.cursor = 'pointer';
                    } else {
                        countElement.className = 'fs-3 fw-bold text-info mb-0';
                        countElement.style.cursor = 'pointer';
                    }
                } else {
                    console.error('Error fetching playlist count:', data.error);
                    document.getElementById('selected-playlists-count').innerText = '?';
                    document.getElementById('selected-playlists-breakdown').innerText = 'Errore caricamento';
                }
            })
            .catch(error => {
                console.error('Error fetching selected playlists count:', error);
                document.getElementById('selected-playlists-count').innerText = '?';
                document.getElementById('selected-playlists-breakdown').innerText = 'Errore connessione';
            });
    }
    
    // Function to check service configuration and show warnings
    function checkServiceConfiguration() {
        const autoDiscovery = document.getElementById('auto_discovery').checked;
        const enableSpotify = document.getElementById('enable_spotify').checked;
        const enableDeezer = document.getElementById('enable_deezer').checked;
        const warningsDiv = document.getElementById('config-warnings');
        const warningText = document.getElementById('config-warning-text');
        
        if (!autoDiscovery) {
            warningsDiv.style.display = 'none';
            return;
        }
        
        fetch('/api/service_config')
            .then(response => response.json())
            .then(configData => {
                if (configData.success) {
                    const config = configData.config;
                    let warnings = [];
                    
                    if (enableSpotify && !config.spotify.auto_discovery_available) {
                        warnings.push('Spotify richiede SPOTIFY_USER_ID configurato');
                    }
                    if (enableDeezer && !config.deezer.auto_discovery_available) {
                        warnings.push('Deezer richiede DEEZER_USER_ID configurato');
                    }
                    
                    if (warnings.length > 0) {
                        warningText.textContent = warnings.join('; ');
                        warningsDiv.style.display = 'block';
                    } else {
                        warningsDiv.style.display = 'none';
                    }
                } else {
                    warningsDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking service config:', error);
                warningsDiv.style.display = 'none';
            });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        // Initial update
        updateDashboard();
        
        // Set up periodic updates
        setInterval(updateDashboard, 15000);
        
        // Add event listeners for configuration checking
        document.getElementById('auto_discovery').addEventListener('change', checkServiceConfiguration);
        document.getElementById('enable_spotify').addEventListener('change', checkServiceConfiguration);
        document.getElementById('enable_deezer').addEventListener('change', checkServiceConfiguration);
        
        // Initial configuration check
        checkServiceConfiguration();
        
        // Add click animations to cards
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-3px)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
            });
        });
        
        // Add click handler for selected playlists count
        document.getElementById('selected-playlists-count').addEventListener('click', function() {
            window.location.href = '{{ url_for('playlist_management') }}';
        });
        
        // Initialize icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Add stop button event listener
        document.getElementById('btn-stop').addEventListener('click', function() {
            if (confirm('{{ _('dashboard.actions.confirm_stop') }}')) {
                this.disabled = true;
                this.innerHTML = '<i data-lucide="loader" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('dashboard.actions.stopping') }}';
                
                fetch('{{ url_for('stop_operation') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Stop request sent successfully');
                        // Update dashboard immediately to reflect stopping state
                        updateDashboard();
                    } else {
                        alert('{{ _('errors.stop_failed') }}: ' + data.error);
                        // Re-enable button on error
                        this.disabled = false;
                        this.innerHTML = '<i data-lucide="square" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('dashboard.actions.stop_operation') }}';
                    }
                })
                .catch(error => {
                    console.error('Error stopping operation:', error);
                    alert('{{ _('errors.stop_error') }}');
                    // Re-enable button on error
                    this.disabled = false;
                    this.innerHTML = '<i data-lucide="square" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('dashboard.actions.stop_operation') }}';
                });
                
                // Refresh icons after content update
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        });
    });
    
    // Function to handle selective sync form submission
    function submitSyncForm() {
        const form = document.getElementById('sync-options-form');
        const formData = new FormData(form);
        
        // Check if at least one service is selected
        const enableSpotify = document.getElementById('enable_spotify').checked;
        const enableDeezer = document.getElementById('enable_deezer').checked;
        const enableAI = document.getElementById('enable_ai').checked;
        const autoDiscovery = document.getElementById('auto_discovery').checked;
        
        if (!enableSpotify && !enableDeezer && !enableAI) {
            alert('{{ _('errors.no_service_selected') }}');
            return;
        }
        
        // If auto-discovery is enabled, check service configuration
        if (autoDiscovery) {
            fetch('/api/service_config')
                .then(response => response.json())
                .then(configData => {
                    if (configData.success) {
                        const config = configData.config;
                        let missingConfigs = [];
                        
                        if (enableSpotify && !config.spotify.auto_discovery_available) {
                            missingConfigs.push('Spotify richiede SPOTIFY_USER_ID');
                        }
                        if (enableDeezer && !config.deezer.auto_discovery_available) {
                            missingConfigs.push('Deezer richiede DEEZER_USER_ID');
                        }
                        
                        if (missingConfigs.length > 0) {
                            alert('Auto-scoperta non disponibile:\n' + missingConfigs.join('\n'));
                            return;
                        }
                        
                        // Configuration is valid, proceed with sync
                        proceedWithSync(form, formData);
                    } else {
                        alert('Errore nella verifica configurazione');
                    }
                })
                .catch(error => {
                    console.error('Error checking service config:', error);
                    alert('Errore nella verifica configurazione');
                });
        } else {
            // No auto-discovery, proceed directly
            proceedWithSync(form, formData);
        }
    }
    
    function proceedWithSync(form, formData) {
        // Disable the sync button during operation
        const syncButton = document.getElementById('btn-sync');
        syncButton.disabled = true;
        syncButton.innerHTML = '<i data-lucide="loader" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('status_messages.starting') }}';
        
        // Submit the form
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Selective sync started successfully');
                // The dashboard will be updated by the periodic status check
                updateDashboard();
            } else {
                alert('{{ _('errors.sync_failed') }}: ' + data.error);
                // Re-enable button on error
                syncButton.disabled = false;
                syncButton.innerHTML = '<i data-lucide="refresh-cw" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('dashboard.actions.sync_now') }}';
            }
        })
        .catch(error => {
            console.error('Error starting selective sync:', error);
            alert('{{ _('errors.sync_error') }}');
            // Re-enable button on error
            syncButton.disabled = false;
            syncButton.innerHTML = '<i data-lucide="refresh-cw" class="me-2" style="width: 18px; height: 18px;"></i>{{ _('dashboard.actions.sync_now') }}';
        });
        
        // Refresh icons after content update
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
</script>
{% endblock %}
